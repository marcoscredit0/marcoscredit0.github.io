console.info("[init phones.min.js]");

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i].trim();
        while (c.charAt(0)==' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length,c.length);
        }
    }
    return "";
}

//jquery is needed
if (typeof jQuery === "undefined") {
    console.error('jQuery não encontrada.');
}else{
    jQuery(function(){
        //check for acesso_token in the cookies list
        var accessToken = ''; 
        
        if (typeof acesso_token !== "undefined") {
            accessToken = acesso_token;
        }else{
            accessToken = getCookie('acesso_token');
            
            if (accessToken == '') {
                accessToken = getCookie('rw[token]');
            }

            if (accessToken === '') {
                //show and error on console if acesso_token is not available
                console.error('Acesso Token não encontrado. O website possui registraAcesso()?');
                return;
            }    
        }
        var data = {
            'acesso_token': accessToken
        };
        //post to the CRM API
        jQuery.post(window.location.protocol + '//crm2.reweb.com.br/_api/companyPhones.class.php', data, function(response){
            if (typeof response == 'string') {
                response = JSON.parse(response)
            }

            if (response.error) {
                //some error occured in the api
                console.error('[CRM API]', response.error_msg);
                return;
            }

            if (response.data && response.data.length > 0) {
                //search the unitID in the response
                //interact with all phones in the page.
                jQuery('.buscaTelefone').each(function(){
                    var unitID = $(this).attr('data-unidade-id');
                    var el = $(this);
                    for(var i = 0; i < response.data.length; i++){
                        if (unitID == response.data[i].cliente_unidade_id) {
                            //put the phone on the html
                        	if(el.is('a'))
                        		el.attr({'href':('tel: '+ response.data[i].telefone)});
                              
                            if(el.parent().is('a'))
                        		el.parent().attr({'href':('tel: '+ response.data[i].telefone)});
                              
                            if(el.parent().parent().is('a'))
                        		el.parent().parent().attr({'href':('tel: '+ response.data[i].telefone)});
                        	
                        	el.html(response.data[i].telefone);
                        }
                    }
                });
                
            }
            
        });
        
    });
}
